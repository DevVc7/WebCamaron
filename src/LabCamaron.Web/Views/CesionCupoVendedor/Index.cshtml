@model List<AsignacionClienteVm>
@{
    ViewData["Title"] = "Cesión Cupo Vendedor";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ceder Cupo Vendedor</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-footer {
            margin-top: 10px;
        }
    </style>
</head>


<!-- Modal -->
<!-- Agregar una tabla al modal para mostrar múltiples módulos -->
<div id="modalEditarCupo" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 id="modalTitulo">Editar Cupo</h5>
        </div>
        <div class="modal-body">
            <table class="table table-bordered text-center" id="tablaModal">
                <thead>
                    <tr>
                        <th>Módulo</th>
                        <th>Cupo Cedido</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button id="guardarCupo" class="btn btn-success">Guardar</button>
            <button id="cerrarModal" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>
</div>



<style>
    .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 40%;
    }

    .modal-header {
        font-weight: bold;
        margin-bottom: 10px;
    }

    .modal-footer {
        margin-top: 10px;
        text-align: right;
    }
</style>

<body>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header text-center">
                <h5>Ceder Cupo Vendedor</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3 text-center p-2 rounded">
                    <div class="col-md-6">
                        <label for="planificacion" class="form-label">Planificación</label>
                        <input type="text" class="form-control text-center" id="planificacion" value="Ene-25 a Feb-25" disabled>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Laboratorio</label>
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <input type="text" class="form-control text-center" id="codigoLaboratorio" value="LAB001" disabled>
                            </div>
                            <div class="col-auto px-1">-</div>
                            <div class="col-md-7">
                                <input type="text" class="form-control text-center w-100" id="nombreLaboratorio" value=" Nombre del Laboratorio" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 text-center">
                    <div class="col-md-6">
                        <label class="form-label">Vendedor A</label>
                        <select class="form-select text-center w-100" id="nombreVendedorA">
                            <option value="" disabled selected>Seleccione</option>
                            <option value="Jaime Medina">Jaime Medina</option>
                            <option value="Lupita Guadalupe">Lupita Guadalupe</option>
                            <option value="Dipper Antonio">Dipper Antonio</option>
                            <option value="Lucas Renato">Lucas Renato</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Vendedor B</label>
                        <select class="form-select text-center w-100" id="nombreVendedorB">
                            <option value="" disabled selected>Seleccione</option>
                            <option value="Jaime Medina">Jaime Medina</option>
                            <option value="Lupita Guadalupe">Lupita Guadalupe</option>
                            <option value="Dipper Antonio">Dipper Antonio</option>
                            <option value="Lucas Renato">Lucas Renato</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <div class="border p-3">
                        <h6>Vendedor A</h6>
                        <table class="table table-bordered text-center" id="tablaVendedorA">
                            <thead>
                                <tr>
                                    <th>Módulo</th>
                                    <th>Cupo Actual</th>
                                    <th>Cupo Cedido</th>
                                    <th>Cupo Nuevo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="border p-3 mt-3">
                        <h6>Vendedor B</h6>
                        <table class="table table-bordered text-center" id="tablaVendedorB">
                            <thead>
                                <tr>
                                    <th>Módulo</th>
                                    <th>Cupo Actual</th>
                                    <th>Cupo Recibido</th>
                                    <th>Cupo Nuevo</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-primary">Grabar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        $(document).ready(function() {
            let datosVendedores = {
                "Jaime Medina": [
                    { modulo: 'Hupo 1', cupoActual: 90 },
                    { modulo: 'Hupo 2', cupoActual: 100 },
                    { modulo: 'Hupo 3', cupoActual: 40 }
                ],
                "Lupita Guadalupe": [
                    { modulo: 'Papa 1', cupoActual: 20 },
                    { modulo: 'Papa 2', cupoActual: 50 },
                    { modulo: 'Papa 3', cupoActual: 90 }
                ],
                "Dipper Antonio": [
                    { modulo: 'Madera 1', cupoActual: 90 },
                    { modulo: 'Madera 2', cupoActual: 87 },
                    { modulo: 'Madera 3', cupoActual: 70 }
                ],
                "Lucas Renato": [
                    { modulo: 'Roca 1', cupoActual: 100 },
                    { modulo: 'Roca 2', cupoActual: 60 },
                    { modulo: 'Roca 3', cupoActual: 29 }
                ]
            };

            function poblarTabla(idTabla, vendedor) {
                let tbody = $(idTabla).find("tbody");
                tbody.empty();

                if (!vendedor || !datosVendedores[vendedor]) return;

                datosVendedores[vendedor].forEach(dato => {
                    let fila = `<tr>
                        <td>${dato.modulo}</td>
                        <td>${dato.cupoActual}</td>
                        <td><span class="cupoCedido">0</span></td>
                        <td>${dato.cupoActual}</td>
                        <td><button class='btn btn-sm btn-primary editar-btn'>Editar</button></td>
                    </tr>`;
                    tbody.append(fila);
                });
            }

            $('#nombreVendedorA').change(function() {
                let vendedor = $(this).val();
                poblarTabla('#tablaVendedorA', vendedor);
            });

            $('#nombreVendedorB').change(function() {
                let vendedor = $(this).val();
                poblarTabla('#tablaVendedorB', vendedor);
            });
        });
    </script>
    <style>
        .modal {
            width: 50%; /* Reducir el ancho del modal */
            max-height: 88vh; /* Limitar la altura del modal */
            overflow-y: auto; /* Permitir desplazamiento si es necesario */
        }
    </style>
    <script>
        $(document).ready(function () {
            let vendedorBSeleccionado = "";

            function guardarEnLocalStorage() {
                let datosA = [];
                let datosB = [];

                $("#tablaVendedorA tbody tr").each(function () {
                    let fila = {
                        modulo: $(this).find('td:nth-child(1)').text(),
                        cupoActual: parseInt($(this).find('td:nth-child(2)').text(), 10),
                        cupoCedido: 0,
                        cupoNuevo: parseInt($(this).find('td:nth-child(2)').text(), 10)
                    };
                    datosA.push(fila);
                });

                $("#tablaVendedorB tbody tr").each(function () {
                    let fila = {
                        modulo: $(this).find('td:nth-child(1)').text(),
                        cupoActual: parseInt($(this).find('td:nth-child(2)').text(), 10),
                        cupoRecibido: 0,
                        cupoNuevo: parseInt($(this).find('td:nth-child(2)').text(), 10)
                    };
                    datosB.push(fila);
                });
            }

            function inicializarTablas(datosA = [], datosB = []) {
                let tbodyA = $("#tablaVendedorA tbody");
                let tbodyB = $("#tablaVendedorB tbody");

                tbodyA.empty();
                tbodyB.empty();

                datosA.forEach(dato => {
                    let fila = `<tr>
                        <td>${dato.modulo}</td>
                        <td>${dato.cupoActual}</td>
                        <td>0</td>
                        <td>${dato.cupoActual}</td>
                        <td><button class='btn btn-sm btn-primary editar-btn'>Editar</button></td>
                    </tr>`;
                    tbodyA.append(fila);
                });

                datosB.forEach(dato => {
                    let fila = `<tr>
                        <td>${dato.modulo}</td>
                        <td>${dato.cupoActual}</td>
                        <td>0</td>
                        <td>${dato.cupoActual}</td>
                    </tr>`;
                    tbodyB.append(fila);
                });
            }

            $("#nombreVendedorA, #nombreVendedorB").change(function () {
                let datosA = [];
                let datosB = [];

                if ($("#nombreVendedorA").val() !== "") {
                    datosA = [
                        { modulo: "Hupo 1", cupoActual: 90 },
                        { modulo: "Hupo 2", cupoActual: 100 },
                        { modulo: "Hupo 3", cupoActual: 40 }
                    ];
                }

                if ($("#nombreVendedorB").val() !== "") {
                    datosB = [
                        { modulo: "Roca 1", cupoActual: 100 },
                        { modulo: "Roca 2", cupoActual: 60 },
                        { modulo: "Roca 3", cupoActual: 29 }
                    ];
                }

                inicializarTablas(datosA, datosB);
            });

            $(document).on('click', '.editar-btn', function () {
                let fila = $(this).closest('tr');
                let modulo = fila.find('td:nth-child(1)').text();
                let cupoActual = parseInt(fila.find('td:nth-child(2)').text(), 10);

                vendedorBSeleccionado = $("#nombreVendedorB").val() || "No seleccionado";

                $("#modalTitulo").text(`Editar Cupo - ${modulo}`);
                $("#vendedorBModal").text(vendedorBSeleccionado);
                $("#cupoCedidoModal").val("");
                $("#tablaModal tbody").empty();

                $("#tablaVendedorB tbody tr").each(function () {
                    let moduloB = $(this).find('td:nth-child(1)').text();
                    let cupoActualB = parseInt($(this).find('td:nth-child(2)').text(), 10);

                    let filaModal = `<tr>
                        <td>${moduloB}</td>
                        <td><input type='number' class='form-control cupoCedidoInput' value='0' min='0' max='${cupoActual}'></td>
                    </tr>`;
                    $("#tablaModal tbody").append(filaModal);
                });

                $("#modalEditarCupo").show();
            });

            $("#cerrarModal").click(function () {
                $("#modalEditarCupo").hide();
            });

            $("#guardarCupo").click(function () {
                let valido = true;
                let cuposCedido = [];

                $(".cupoCedidoInput").each(function () {
                    let valor = parseInt($(this).val(), 10);
                    let maximo = parseInt($(this).attr('max'), 10);

                    if (valor > maximo) {
                        alert(`No puedes ceder más de ${maximo} en el módulo ${$(this).closest('tr').find('td:first').text()}.`);
                        valido = false;
                        return false;
                    }
                    cuposCedido.push({
                        modulo: $(this).closest('tr').find('td:first').text(),
                        valor: valor
                    });
                });

                if (valido) {
                    cuposCedido.forEach(cupo => {
                        $("#tablaVendedorA tbody tr").each(function () {
                            if ($(this).find('td:first').text() === cupo.modulo) {
                                $(this).find('td:nth-child(3)').text(cupo.valor);
                                let cupoActual = parseInt($(this).find('td:nth-child(2)').text(), 10);
                                $(this).find('td:nth-child(4)').text(cupoActual - cupo.valor);
                            }
                        });

                        $("#tablaVendedorB tbody tr").each(function () {
                            if ($(this).find('td:first').text() === cupo.modulo) {
                                $(this).find('td:nth-child(3)').text(cupo.valor);
                                let cupoActual = parseInt($(this).find('td:nth-child(2)').text(), 10);
                                $(this).find('td:nth-child(4)').text(cupoActual + cupo.valor);
                            }
                        });
                    });

                    alert("Cupos actualizados correctamente.");
                    $("#modalEditarCupo").hide();
                }
            });
        });
    </script>





</body>
</html>
